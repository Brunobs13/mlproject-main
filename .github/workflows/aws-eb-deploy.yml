name: AWS ECR + Elastic Beanstalk Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.11"
  IMAGE_TAG: latest
  AWS_REGION: ${{ vars.AWS_REGION || secrets.AWS_REGION || 'eu-north-1' }}

jobs:
  test:
    name: Optional Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests (optional)
        continue-on-error: true
        run: |
          pytest -q || echo "No tests / optional tests failed, continuing"

  build-and-push-ecr:
    name: Build and Push Docker Image to ECR
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || secrets.AWS_REGION || 'eu-north-1' }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          docker build -t "$ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_TAG}" .
          docker tag "$ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_TAG}" "$ECR_REGISTRY/$ECR_REPOSITORY:${COMMIT_SHA}"
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:${IMAGE_TAG}"
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:${COMMIT_SHA}"

  deploy-elastic-beanstalk:
    name: Deploy Source Bundle to Elastic Beanstalk
    runs-on: ubuntu-latest
    needs: build-and-push-ecr
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || secrets.AWS_REGION || 'eu-north-1' }}

      - name: Create deployment bundle
        run: |
          zip -r deploy.zip . \
            -x ".git/*" ".github/*" ".venv/*" "pastas */*" "*.pyc" "__pycache__/*" ".DS_Store"

      - name: Upload bundle to S3 (for EB application version)
        env:
          EB_S3_BUCKET: ${{ secrets.EB_S3_BUCKET }}
          VERSION_LABEL: gha-${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          aws s3 cp deploy.zip "s3://${EB_S3_BUCKET}/beanstalk/${VERSION_LABEL}.zip"

      - name: Create Elastic Beanstalk application version
        env:
          EB_APP_NAME: ${{ secrets.EB_APPLICATION_NAME }}
          EB_S3_BUCKET: ${{ secrets.EB_S3_BUCKET }}
          VERSION_LABEL: gha-${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name "${EB_APP_NAME}" \
            --version-label "${VERSION_LABEL}" \
            --source-bundle S3Bucket="${EB_S3_BUCKET}",S3Key="beanstalk/${VERSION_LABEL}.zip" \
            --auto-create-application

      - name: Deploy application version to environment
        env:
          EB_ENV_NAME: ${{ secrets.EB_ENVIRONMENT_NAME }}
          VERSION_LABEL: gha-${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          aws elasticbeanstalk update-environment \
            --environment-name "${EB_ENV_NAME}" \
            --version-label "${VERSION_LABEL}"
